<%- include('partial/header', { title: 'Wishmewell Apartment',email:email,roleName:roleName }) %>
<%- include('partial/sidebar', { name: name}) %>


<div class="page-wrapper">
<div class="content mt-5">
<div class="row">
<div class="col-sm-5 col-4">
<h4 class="page-title">Booking Details</h4>
</div>
<div class="col-sm-7 col-8 text-right m-b-30">
<div class="btn-group btn-group-sm">
<button class="btn btn-warning" data-toggle="modal" data-target="#transferRoomModal">
	<i class="fas fa-exchange-alt"></i> Transfer Room
</button>
<!-- <button class="btn btn-primary">CSV</button>
<button class="btn btn-primary">PDF</button>
<button class="btn btn-primary"><i class="fas fa-print fa-lg"></i> Print</button> -->
</div>
</div>
</div>

<!-- Tabs Navigation -->
<ul class="nav nav-tabs" role="tablist" style="margin-bottom: 20px;">
	<li class="nav-item">
		<a class="nav-link active" id="details-tab" data-toggle="tab" href="#details" role="tab">
			<i class="fas fa-info-circle"></i> Booking Details
		</a>
	</li>
	<li class="nav-item">
		<a class="nav-link" id="transfer-history-tab" data-toggle="tab" href="#transfer-history" role="tab">
			<i class="fas fa-history"></i> Transfer History
		</a>
	</li>
</ul>

<!-- Tab Content -->
<div class="tab-content"  style="margin-bottom: 20px;">
	<!-- Booking Details Tab -->
	<div class="tab-pane fade show active" id="details" role="tabpanel">
<div class="row">
<div class="col-md-12">
<div class="card-box">
<!-- <h4 class="payslip-title text-center">booked on</h4> -->
<div class="row">
<div class="col-sm-6 m-b-20">
<img src="assets/img/apple-touch-icon.png" class="inv-logo" alt="image" style="background-color: grey;border-radius: 50%;">
<ul class="list-unstyled mb-0">
<li>Hotel</li>
<li>66 Campbell Street Lagos Onikan TBS</li>
<li>Lagos State, Nigeria</li>
</ul>
</div>
<div class="col-sm-6 m-b-20">
<div class="invoice-details">
<h3 class="text-uppercase">KEY: <%= bookings.reference_id %></h3>
<ul class="list-unstyled">
<li>Booked On: <span><%= new Date(bookings.createdAt).toLocaleString() %></span></li>
<li>Booked By: 
	<span>
		<%= bookings.booked_by.trim() === '' ? 'self' : bookings.booked_by %>
	</span>	
</li>
<a href="/payments/result?reference=<%= bookings.reference_id %>" class="btn btn-primary btn-block">Generate receipt</a>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-lg-12 m-b-20">
<ul class="list-unstyled">
<li>
<h5 class="mb-0"><strong><%= bookings.guest_name %></strong></h5>
</li>
<li><span><%= bookings.guest_phone %></span></li>
<li><%= bookings.guest_email %></li>
<li><%= bookings.guest_address %></li>
</ul>
</div>
</div>
<div class="row">
<div class="col-sm-6">
<div>
<h4 class="m-b-10"><strong>ROOM DETAILS</strong></h4>
<table class="table table-bordered">
<tbody>
<tr>
<td><strong>Room Category</strong> <span class="float-right"><%= bookings.category_name %></span></td>
</tr>
<tr>
<td><strong>Room Name</strong> <span class="float-right"><%= bookings.room_name %></span></td>
</tr>
<tr>
<td><strong>Room Number</strong> <span class="float-right"><%= bookings.room_number %></span>
</td>
</tr>
<tr>
<td><strong>Duration</strong> <span class="float-right"><%= bookings.night %> night</span></td>
</tr>
<tr>
<td><strong>Amount</strong> <span class="float-right"><strong>‚Ç¶<%= bookings.amount %></strong></span></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="col-sm-6">
<div>
<h4 class="m-b-10"><strong>Checking Status</strong></h4>
<table class="table table-bordered">
<tbody>
<tr>
	<td>
		<strong>Check User In</strong>
		<span class="float-right">
		  <% if (!bookings.checked_in) { %>
			<button class="btn btn-primary " id="checkInBtn">check customer in now</button>
		  <% } else { %>
			Already Checked
		  <% } %>
		</span>
	  </td>
	  
</tr>
<tr>
	<td>
		<strong>User CheckOut Date</strong>
		<span class="float-right">
		  <% if (!bookings.checked_out) { %>
			<div class="btn  " id="checkIn">customer will be checkout on <%=new Date(bookings.end).toLocaleString()  %></div>
		  <% } else { %>
			this booking date has passed <%=new Date(bookings.end).toLocaleString()  %>
		  <% } %>
		</span>
	  </td>
	  
</tr>
<tr>
<!-- <td><strong>User CheckOut Date</strong> <span class="float-right"><%= new Date(bookings.end).toLocaleString() %></span></td> -->
</tr>
<!-- <tr>
<td><strong></strong> <span class="float-right">$0</span></td>
</tr>
<tr>
<td><strong>Loan</strong> <span class="float-right">$300</span></td>
</tr>
<tr>
<td><strong>Total Deductions</strong> <span class="float-right"><strong>$59698</strong></span></td>
</tr> -->
</tbody>
</table>
</div>
</div>
<!-- <div class="col-sm-12">
<p><strong>Net Salary: $59698</strong> (Fifty nine thousand six hundred and ninety
eight only.)</p> -->
</div>
</div>
</div>
</div>
</div>
</div>
</div>
	</div>
	<!-- End Booking Details Tab -->

	<!-- Transfer History Tab -->
	<div class="tab-pane fade" id="transfer-history" role="tabpanel">
		<div class="row">
			<div class="col-md-12">
				<div class="card-box">
					<h4 class="m-b-20"><i class="fas fa-history"></i> Room Transfer History</h4>
					<div class="table-responsive">
						<table class="table table-bordered table-hover" id="transferHistoryTable">
							<thead style="background: linear-gradient(135deg, #6b6b6b 0%, #9e9e9e 100%); color: white;">
								<tr>
									<th>Date & Time</th>
									<th>From Room</th>
									<th>To Room</th>
									<th>Transferred By</th>
									<th>Reason</th>
								</tr>
							</thead>
							<tbody id="transferHistoryBody">
								<tr>
									<td colspan="5" class="text-center">
										<i class="fas fa-spinner fa-spin"></i> Loading transfer history...
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- End Transfer History Tab -->
</div>

</div>

<!-- Transfer Room Modal -->
<div class="modal fade" id="transferRoomModal" tabindex="-1" role="dialog" aria-labelledby="transferRoomModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header" style="background: linear-gradient(135deg, #6b6b6b 0%, #9e9e9e 100%); color: white;">
				<h5 class="modal-title" id="transferRoomModalLabel">
					<i class="fas fa-exchange-alt"></i> Transfer Room
				</h5>
				<button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="alert alert-info">
					<i class="fas fa-info-circle"></i>
					<strong>Current Room:</strong> <%= bookings.room_number %> (<%= bookings.room_name %>)
					<br>
					<strong>Guest:</strong> <%= bookings.guest_name %>
					<br>
					<strong>Booking Period:</strong> <%= new Date(bookings.start).toLocaleDateString() %> - <%= new Date(bookings.end).toLocaleDateString() %>
				</div>

				<form id="transferRoomForm">
					<div class="form-group">
						<label for="newRoomCategory"><strong>Select New Room Category</strong></label>
						<select class="form-control" id="newRoomCategory" required>
							<option value="">-- Select Category --</option>
						</select>
					</div>

					<div class="form-group" id="newRoomNumberGroup" style="display: none;">
						<label for="newRoomNumber"><strong>Select New Room</strong></label>
						<select class="form-control" id="newRoomNumber" required>
							<option value="">-- Select Room --</option>
						</select>
						<small class="form-text text-muted">Only available rooms in the selected category are shown</small>
					</div>

					<div class="alert alert-warning" style="display: none;" id="transferWarning">
						<i class="fas fa-exclamation-triangle"></i>
						<strong>Note:</strong> The booking dates and guest information will remain the same. Only the room assignment will change.
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" id="confirmTransferBtn" disabled>
					<i class="fas fa-check"></i> Confirm Transfer
				</button>
			</div>
		</div>
	</div>
</div>

<script src="assets/js/jquery-3.5.1.min.js"></script>
<script src="assets/js/popper.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/js/moment.min.js"></script>
<script src="assets/js/select2.min.js"></script>
<script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="assets/js/bootstrap-datetimepicker.min.js"></script>
<script src="assets/plugins/datatables/datatables.min.js"></script>
<script src="assets/js/script.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

<script>
	// Check-in button handler
	const checkInBtn = document.getElementById('checkInBtn');
	if (checkInBtn) {
		checkInBtn.addEventListener('click', async function(event) {
			const url = new URL(window.location.href);
			const id = url.searchParams.get('key');
			const response = await fetch(`/portal/check-in?key=${id.trim()}`,{method:"POST",headers:{"Content-Type": "application"}});
			const data = await response.json();
			if (data.status) {
				window.location.reload();
			}
			console.log("üöÄ ~ data:", data)
		});
	}

	// Room Transfer functionality
	let availableRooms = [];
	const currentBooking = {
		reference_id: '<%= bookings.reference_id %>',
		category_id: <%= bookings.category_id %>,
		room_id: <%= bookings.room_id %>,
		room_number: '<%= bookings.room_number %>',
		start: '<%= bookings.start %>',
		end: '<%= bookings.end %>'
	};

	// Load categories when modal opens
	$('#transferRoomModal').on('show.bs.modal', async function () {
		try {
			console.log('üîÑ Loading categories from: /portal/api/hotel/categories');
			const response = await fetch('/portal/api/hotel/categories', {
				method: 'GET',
				headers: {
					'Content-Type': 'application/json',
					'Cache-Control': 'no-cache'
				}
			});

			if (!response.ok) {
				throw new Error(`HTTP error! status: ${response.status}`);
			}

			const data = await response.json();
			console.log('‚úÖ Categories loaded:', data);

			const categorySelect = document.getElementById('newRoomCategory');
			categorySelect.innerHTML = '<option value="">-- Select Category --</option>';

			if (data.status && data.data && data.data.categories) {
				data.data.categories.forEach(category => {
					const option = document.createElement('option');
					option.value = category._id;
					const price = parseFloat(category.price); // Price is already in naira
					option.textContent = `${category.category_name} - ‚Ç¶${price.toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
					option.dataset.categoryName = category.category_name;
					categorySelect.appendChild(option);
				});
				console.log(`‚úÖ Loaded ${data.data.categories.length} categories`);
			} else {
				console.warn('‚ö†Ô∏è No categories found in response');
			}
		} catch (error) {
			console.error('‚ùå Error loading categories:', error);
			showToast('Failed to load room categories: ' + error.message, 'error');
		}
	});

	// Load available rooms when category is selected
	document.getElementById('newRoomCategory').addEventListener('change', async function() {
		const categoryId = this.value;
		const categoryName = this.options[this.selectedIndex].dataset.categoryName;

		if (!categoryId) {
			document.getElementById('newRoomNumberGroup').style.display = 'none';
			document.getElementById('confirmTransferBtn').disabled = true;
			return;
		}

		try {
			// Fetch available rooms for this category
			console.log(`üîÑ Loading rooms for category ${categoryId} from: /portal/api/hotel/rooms/category/${categoryId}`);
			const response = await fetch(`/portal/api/hotel/rooms/category/${categoryId}`, {
				method: 'GET',
				headers: {
					'Content-Type': 'application/json',
					'Cache-Control': 'no-cache'
				}
			});

			if (!response.ok) {
				throw new Error(`HTTP error! status: ${response.status}`);
			}
			const data = await response.json();
			console.log('‚úÖ Rooms loaded:', data);

			const roomSelect = document.getElementById('newRoomNumber');
			roomSelect.innerHTML = '<option value="">-- Select Room --</option>';

			// Filter out the current room and booked rooms
			availableRooms = data.data.rooms.filter(room =>
				!room.status && room.room_number !== currentBooking.room_number
			);

			console.log(`‚úÖ Found ${availableRooms.length} available rooms`);

			if (availableRooms.length === 0) {
				roomSelect.innerHTML = '<option value="">No available rooms in this category</option>';
				document.getElementById('newRoomNumberGroup').style.display = 'block';
				document.getElementById('confirmTransferBtn').disabled = true;
				console.warn('‚ö†Ô∏è No available rooms in this category');
				return;
			}

			availableRooms.forEach(room => {
				const option = document.createElement('option');
				option.value = room._id;
				option.textContent = `Room ${room.room_number} - ${room.room_name}`;
				option.dataset.roomNumber = room.room_number;
				option.dataset.roomName = room.room_name;
				roomSelect.appendChild(option);
			});

			document.getElementById('newRoomNumberGroup').style.display = 'block';
			document.getElementById('transferWarning').style.display = 'block';
		} catch (error) {
			console.error('‚ùå Error loading rooms:', error);
			showToast('Failed to load available rooms: ' + error.message, 'error');
		}
	});

	// Enable confirm button when room is selected
	document.getElementById('newRoomNumber').addEventListener('change', function() {
		document.getElementById('confirmTransferBtn').disabled = !this.value;
	});

	// Handle transfer confirmation
	document.getElementById('confirmTransferBtn').addEventListener('click', async function() {
		const newCategoryId = document.getElementById('newRoomCategory').value;
		const newRoomId = document.getElementById('newRoomNumber').value;
		const newRoomSelect = document.getElementById('newRoomNumber');
		const newRoomNumber = newRoomSelect.options[newRoomSelect.selectedIndex].dataset.roomNumber;
		const newRoomName = newRoomSelect.options[newRoomSelect.selectedIndex].dataset.roomName;
		const newCategoryName = document.getElementById('newRoomCategory').options[document.getElementById('newRoomCategory').selectedIndex].dataset.categoryName;

		if (!newRoomId) {
			showToast('Please select a room', 'error');
			return;
		}

		// Confirm with user
		if (!confirm(`Are you sure you want to transfer this booking from Room ${currentBooking.room_number} to Room ${newRoomNumber}?`)) {
			return;
		}

		try {
			this.disabled = true;
			this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Transferring...';

			const response = await fetch('/portal/transfer-room', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					reference_id: currentBooking.reference_id,
					old_room_id: currentBooking.room_id,
					old_room_number: currentBooking.room_number,
					new_room_id: newRoomId,
					new_room_number: newRoomNumber,
					new_room_name: newRoomName,
					new_category_id: newCategoryId,
					new_category_name: newCategoryName
				})
			});

			const data = await response.json();

			if (data.status) {
				showToast('Room transferred successfully!', 'success');
				setTimeout(() => {
					window.location.reload();
				}, 1500);
			} else {
				showToast(data.message || 'Failed to transfer room', 'error');
				this.disabled = false;
				this.innerHTML = '<i class="fas fa-check"></i> Confirm Transfer';
			}
		} catch (error) {
			console.error('Error transferring room:', error);
			showToast('An error occurred while transferring the room', 'error');
			this.disabled = false;
			this.innerHTML = '<i class="fas fa-check"></i> Confirm Transfer';
		}
	});

	function showToast(message, type) {
		const backgroundColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107';
		Toastify({
			text: message,
			duration: 3000,
			gravity: "top",
			position: "center",
			style: { background: backgroundColor },
		}).showToast();
	}

	// Load transfer history when tab is clicked
	$('#transfer-history-tab').on('click', async function() {
		const tbody = document.getElementById('transferHistoryBody');

		// Show loading state
		tbody.innerHTML = `
			<tr>
				<td colspan="5" class="text-center">
					<i class="fas fa-spinner fa-spin"></i> Loading transfer history...
				</td>
			</tr>
		`;

		try {
			console.log('Fetching transfer history for:', currentBooking.reference_id);
			const response = await fetch(`/portal/room-transfer-history?reference_id=${currentBooking.reference_id}`);
			const data = await response.json();

			console.log('Transfer history response:', data);

			if (data.status && data.data && data.data.transfers && data.data.transfers.length > 0) {
				tbody.innerHTML = '';
				data.data.transfers.forEach(transfer => {
					const row = document.createElement('tr');
					row.innerHTML = `
						<td>${new Date(transfer.createdAt).toLocaleString('en-GB', {
							year: 'numeric',
							month: 'short',
							day: 'numeric',
							hour: '2-digit',
							minute: '2-digit'
						})}</td>
						<td>
							<strong>${transfer.old_room_number}</strong> - ${transfer.old_room_name || 'N/A'}<br>
							<small class="text-muted">${transfer.old_category_name || 'N/A'}</small>
						</td>
						<td>
							<strong>${transfer.new_room_number}</strong> - ${transfer.new_room_name || 'N/A'}<br>
							<small class="text-muted">${transfer.new_category_name || 'N/A'}</small>
						</td>
						<td>${transfer.transferred_by}</td>
						<td>${transfer.transfer_reason || '<em class="text-muted">No reason provided</em>'}</td>
					`;
					tbody.appendChild(row);
				});
			} else {
				tbody.innerHTML = `
					<tr>
						<td colspan="5" class="text-center text-muted">
							<i class="fas fa-info-circle"></i> No transfer history found for this booking
						</td>
					</tr>
				`;
			}
		} catch (error) {
			console.error('Error loading transfer history:', error);
			tbody.innerHTML = `
				<tr>
					<td colspan="5" class="text-center text-danger">
						<i class="fas fa-exclamation-triangle"></i> Failed to load transfer history: ${error.message}
					</td>
				</tr>
			`;
		}
	});
</script>
</body>
</html>