<%- include('partial/header', { title: 'Pricing Configuration - Wishmewell Apartment',email:email,roleName:roleName }) %>
<%- include('partial/sidebar', { name: name}) %>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<div class="page-wrapper">
    <div class="content container-fluid">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <div class="mt-5">
                        <h4 class="card-title float-left mt-2">
                            <i class="fas fa-tags" style="color: #6b6b6b;"></i> Dynamic Pricing Configuration
                        </h4>
                        <button class="btn btn-primary float-right veiwbutton" data-toggle="modal" data-target="#createPricingModal">
                            <i class="fas fa-plus"></i> Add New Pricing
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Alert -->
        <div class="row">
            <div class="col-sm-12">
                <div class="alert alert-info" style="border-left: 4px solid #6b6b6b;">
                    <i class="fas fa-info-circle"></i>
                    <strong>How it works:</strong> Set special pricing for room categories during specific date ranges.
                    The system will automatically apply these prices for bookings made within the configured dates.
                    Prices revert to default after the end date.
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <div class="card card-table">
                    <div class="card-body booking_card">
                        <div class="table-responsive">
                            <table class="datatable table table-stripped table table-hover table-center mb-0">
                                <thead>
                                    <tr>
                                        <th>S/N</th>
                                        <th>Category</th>
                                        <th>Special Price</th>
                                        <th>Date Range</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Created By</th>
                                        <th class="text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (pricingConfigs.length === 0) { %>
                                        <tr>
                                            <td colspan="8" class="text-center">
                                                <div class="py-5">
                                                    <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                                                    <p class="text-muted">No pricing configurations found. Click "Add New Pricing" to create one.</p>
                                                </div>
                                            </td>
                                        </tr>
                                    <% } else { %>
                                        <% pricingConfigs.forEach((config, index) => {
                                            const now = new Date();
                                            const startDate = new Date(config.start_date);
                                            const endDate = new Date(config.end_date);
                                            const isCurrentlyActive = config.is_active && now >= startDate && now <= endDate;
                                            const isPending = config.is_active && now < startDate;
                                            const isExpired = now > endDate;
                                            const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                                        %>
                                            <tr style="<%= isCurrentlyActive ? 'background-color: #f0f9ff;' : '' %>">
                                                <td><%= index + 1 %></td>
                                                <td>
                                                    <strong style="color: #6b6b6b;">
                                                        <i class="fas fa-bed"></i> <%= config.category_name %>
                                                    </strong>
                                                </td>
                                                <td>
                                                    <h5 class="mb-0" style="color: #28a745;">
                                                        ₦<%= parseFloat(config.special_price).toLocaleString() %>
                                                    </h5>
                                                    <small class="text-muted">per night</small>
                                                </td>
                                                <td>
                                                    <small>
                                                        <i class="fas fa-calendar-alt" style="color: #6b6b6b;"></i>
                                                        <%= new Date(config.start_date).toLocaleDateString('en-GB') %>
                                                    </small>
                                                    <br>
                                                    <small>
                                                        <i class="fas fa-arrow-down"></i>
                                                    </small>
                                                    <br>
                                                    <small>
                                                        <i class="fas fa-calendar-alt" style="color: #dc3545;"></i>
                                                        <%= new Date(config.end_date).toLocaleDateString('en-GB') %>
                                                    </small>
                                                </td>
                                                <td>
                                                    <span class="badge badge-info">
                                                        <%= duration %> day<%= duration > 1 ? 's' : '' %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <% if (isCurrentlyActive) { %>
                                                        <span class="badge badge-pill badge-success" style="padding: 5px 10px;">
                                                            <i class="fas fa-check-circle"></i> Active Now
                                                        </span>
                                                    <% } else if (isPending) { %>
                                                        <span class="badge badge-pill badge-warning" style="padding: 5px 10px;">
                                                            <i class="fas fa-clock"></i> Pending
                                                        </span>
                                                    <% } else if (isExpired) { %>
                                                        <span class="badge badge-pill badge-secondary" style="padding: 5px 10px;">
                                                            <i class="fas fa-history"></i> Expired
                                                        </span>
                                                    <% } else if (!config.is_active) { %>
                                                        <span class="badge badge-pill badge-dark" style="padding: 5px 10px;">
                                                            <i class="fas fa-ban"></i> Inactive
                                                        </span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <small>
                                                        <i class="fas fa-user"></i> <%= config.created_by %>
                                                    </small>
                                                </td>
                                                <td class="text-right">
                                                    <div class="btn-group">
                                                        <% if (config.is_active && !isExpired) { %>
                                                            <button class="btn btn-sm btn-warning" onclick="deactivatePricing(<%= config._id %>)" title="Deactivate">
                                                                <i class="fas fa-pause"></i>
                                                            </button>
                                                        <% } %>
                                                        <button class="btn btn-sm btn-danger" onclick="deletePricing(<%= config._id %>)" title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Pricing Modal -->
<div class="modal fade" id="createPricingModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #6b6b6b 0%, #9e9e9e 100%); color: white;">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Create Pricing Configuration
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="createPricingForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Tip:</strong> Set special pricing for holidays, events, or promotional periods.
                        The system will automatically apply these prices during the configured dates.
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">
                            <i class="fas fa-bed"></i> Room Category <span class="text-danger">*</span>
                        </label>
                        <select class="form-control form-control-lg" name="category_id" id="category_id" required>
                            <option value="">-- Select Room Category --</option>
                            <% categories.forEach(cat => { %>
                                <option value="<%= cat._id %>"
                                        data-name="<%= cat.category_name %>"
                                        data-price="<%= cat.price %>">
                                    <%= cat.category_name %> (Current Price: ₦<%= parseFloat(cat.price).toLocaleString() %>/night)
                                </option>
                            <% }) %>
                        </select>
                    </div>

                    <div id="currentPriceInfo" class="alert alert-secondary" style="display: none;">
                        <strong>Current Price:</strong> <span id="currentPriceDisplay"></span>
                    </div>

                    <div class="form-group">
                        <label class="font-weight-bold">
                            <i class="fas fa-tag"></i> Special Price (₦) <span class="text-danger">*</span>
                        </label>
                        <div class="input-group input-group-lg">
                            <div class="input-group-prepend">
                                <span class="input-group-text" style="background-color: #6b6b6b; color: white;">
                                    <i class="fas fa-naira-sign"></i>
                                </span>
                            </div>
                            <input type="number"
                                   class="form-control"
                                   name="special_price"
                                   id="special_price"
                                   step="0.01"
                                   placeholder="Enter special price per night"
                                   required>
                        </div>
                        <small class="form-text text-muted">Enter the promotional price per night</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fas fa-calendar-check"></i> Start Date & Time <span class="text-danger">*</span>
                                </label>
                                <input type="datetime-local"
                                       class="form-control form-control-lg"
                                       name="start_date"
                                       id="start_date"
                                       required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="font-weight-bold">
                                    <i class="fas fa-calendar-times"></i> End Date & Time <span class="text-danger">*</span>
                                </label>
                                <input type="datetime-local"
                                       class="form-control form-control-lg"
                                       name="end_date"
                                       id="end_date"
                                       required>
                            </div>
                        </div>
                    </div>

                    <div id="durationInfo" class="alert alert-success" style="display: none;">
                        <i class="fas fa-clock"></i>
                        <strong>Duration:</strong> <span id="durationDisplay"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn" style="background-color: #6b6b6b; border-color: #6b6b6b;">
                        <i class="fas fa-save"></i> Create Pricing
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="assets/js/jquery-3.5.1.min.js"></script>
<script src="assets/js/popper.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="assets/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="assets/plugins/datatables/datatables.min.js"></script>
<script src="assets/js/script.js"></script>

<script>
    // Show current price when category is selected
    document.getElementById('category_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const currentPrice = selectedOption.getAttribute('data-price');
        const currentPriceInfo = document.getElementById('currentPriceInfo');
        const currentPriceDisplay = document.getElementById('currentPriceDisplay');

        if (currentPrice) {
            currentPriceDisplay.textContent = '₦' + parseFloat(currentPrice).toLocaleString() + '/night';
            currentPriceInfo.style.display = 'block';
        } else {
            currentPriceInfo.style.display = 'none';
        }
    });

    // Calculate and display duration
    function updateDuration() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const durationInfo = document.getElementById('durationInfo');
        const durationDisplay = document.getElementById('durationDisplay');

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

            if (duration > 0) {
                durationDisplay.textContent = duration + ' day' + (duration > 1 ? 's' : '');
                durationInfo.style.display = 'block';
            } else {
                durationInfo.style.display = 'none';
            }
        } else {
            durationInfo.style.display = 'none';
        }
    }

    document.getElementById('start_date').addEventListener('change', updateDuration);
    document.getElementById('end_date').addEventListener('change', updateDuration);

    document.getElementById('createPricingForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submitBtn');
        const formData = new FormData(this);
        const categorySelect = document.getElementById('category_id');
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];

        // Validate dates
        const startDate = new Date(formData.get('start_date'));
        const endDate = new Date(formData.get('end_date'));

        if (endDate <= startDate) {
            Toastify({
                text: "End date must be after start date",
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: "red" }
            }).showToast();
            return;
        }

        const data = {
            category_id: formData.get('category_id'),
            category_name: selectedOption.getAttribute('data-name'),
            special_price: formData.get('special_price'),
            start_date: formData.get('start_date'),
            end_date: formData.get('end_date')
        };

        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('/portal/pricing-config/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            Toastify({
                text: result.message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: response.ok ? "green" : "red" }
            }).showToast();

            if (response.ok) {
                setTimeout(() => location.reload(), 1500);
            }
        } catch (error) {
            Toastify({
                text: "An error occurred",
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: "red" }
            }).showToast();
        } finally {
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Create Pricing';
            submitBtn.disabled = false;
        }
    });
    
    async function deactivatePricing(id) {
        if (!confirm('Are you sure you want to deactivate this pricing?')) return;
        
        try {
            const response = await fetch(`/portal/pricing-config/deactivate?id=${id}`, {
                method: 'PUT'
            });
            
            const result = await response.json();
            
            Toastify({
                text: result.message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: response.ok ? "green" : "red" }
            }).showToast();
            
            if (response.ok) {
                setTimeout(() => location.reload(), 1500);
            }
        } catch (error) {
            Toastify({
                text: "An error occurred",
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: "red" }
            }).showToast();
        }
    }
    
    async function deletePricing(id) {
        if (!confirm('Are you sure you want to delete this pricing configuration?')) return;
        
        try {
            const response = await fetch(`/portal/pricing-config/delete?id=${id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            Toastify({
                text: result.message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: response.ok ? "green" : "red" }
            }).showToast();
            
            if (response.ok) {
                setTimeout(() => location.reload(), 1500);
            }
        } catch (error) {
            Toastify({
                text: "An error occurred",
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: "red" }
            }).showToast();
        }
    }
</script>
</body>
</html>

