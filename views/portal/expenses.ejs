<%- include('partial/header', { title: 'Expenses - Wishmewell Apartment',email:email,roleName:roleName }) %>
<%- include('partial/sidebar', { name: name}) %>

<div class="page-wrapper">
    <div class="content container-fluid">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <div class="mt-5">
                        <h4 class="card-title float-left mt-2">
                            <i class="fas fa-receipt" style="color: #6b6b6b;"></i> Expenses Management
                        </h4>
                        <button class="btn btn-primary float-right veiwbutton" data-toggle="modal" data-target="#addExpenseModal">
                            <i class="fas fa-plus"></i> Add Expense
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-xl-4 col-sm-6 col-12">
                <div class="card board1 fill">
                    <div class="card-body">
                        <div class="dash-widget-header">
                            <div>
                                <h3 class="card_widget_header"><%= expenses.length %></h3>
                                <h6 class="text-muted">Total Expenses</h6>
                            </div>
                            <div class="ml-auto mt-md-3 mt-lg-0">
                                <span class="opacity-7 text-muted">
                                    <i class="fas fa-list fa-2x" style="color: #6b6b6b;"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4 col-sm-6 col-12">
                <div class="card board1 fill">
                    <div class="card-body">
                        <div class="dash-widget-header">
                            <div>
                                <h3 class="card_widget_header" style="color: #dc3545;">
                                    ₦<%= expenses.reduce((sum, e) => sum + (e.amount / 100), 0).toLocaleString() %>
                                </h3>
                                <h6 class="text-muted">Total Amount</h6>
                            </div>
                            <div class="ml-auto mt-md-3 mt-lg-0">
                                <span class="opacity-7 text-muted">
                                    <i class="fas fa-money-bill-wave fa-2x" style="color: #dc3545;"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4 col-sm-6 col-12">
                <div class="card board1 fill">
                    <div class="card-body">
                        <div class="dash-widget-header">
                            <div>
                                <h3 class="card_widget_header">
                                    <%= new Date().toLocaleDateString('en-GB', { month: 'long', year: 'numeric' }) %>
                                </h3>
                                <h6 class="text-muted">Current Period</h6>
                            </div>
                            <div class="ml-auto mt-md-3 mt-lg-0">
                                <span class="opacity-7 text-muted">
                                    <i class="fas fa-calendar fa-2x" style="color: #6b6b6b;"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <div class="card card-table">
                    <div class="card-body booking_card">
                        <!-- Date Filter and Download Section -->
                        <div class="mb-4">
                            <form method="get" action="/portal/expenses" id="filterForm">
                                <div class="row align-items-end">
                                    <div class="col-md-3">
                                        <label for="start_date" class="font-weight-bold">
                                            <i class="fas fa-calendar-alt"></i> Start Date
                                        </label>
                                        <input type="date" id="start_date" name="start" class="form-control">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="end_date" class="font-weight-bold">
                                            <i class="fas fa-calendar-alt"></i> End Date
                                        </label>
                                        <input type="date" id="end_date" name="end" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-primary mr-2">
                                            <i class="fas fa-filter"></i> Filter
                                        </button>
                                        <button type="button" id="download-csv" class="btn btn-success mr-2">
                                            <i class="fas fa-download"></i> Download CSV
                                        </button>
                                        <a href="/portal/expenses" class="btn btn-secondary">
                                            <i class="fas fa-redo"></i> Reset
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="table-responsive">
                            <table class="datatable table table-stripped table table-hover table-center mb-0">
                                <thead>
                                    <tr>
                                        <th>S/N</th>
                                        <th>Expense Name</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Recorded By</th>
                                        <th class="text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (expenses && expenses.length > 0) { %>
                                        <% expenses.forEach((expense, index) => { %>
                                            <tr>
                                                <td><%= index + 1 %></td>
                                                <td><strong><%= expense.expense_name %></strong></td>
                                                <td>
                                                    <span class="badge badge-info"><%= expense.category %></span>
                                                </td>
                                                <td>
                                                    <strong style="color: #dc3545;">
                                                        ₦<%= (expense.amount / 100).toLocaleString('en-NG', {minimumFractionDigits: 2}) %>
                                                    </strong>
                                                </td>
                                                <td><%= new Date(expense.expense_date).toLocaleDateString('en-GB') %></td>
                                                <td><%= expense.description || 'N/A' %></td>
                                                <td><%= expense.recorded_by || 'N/A' %></td>
                                                <td class="text-right">
                                                    <button class="btn btn-sm btn-warning" onclick="editExpense(<%= expense._id %>)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteExpense(<%= expense._id %>)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="8" class="text-center">No expenses found</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background: #6b6b6b; color: white;">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle"></i> Add New Expense
                </h5>
                <button type="button" class="close" data-dismiss="modal" style="color: white;">
                    <span>&times;</span>
                </button>
            </div>
            <form id="addExpenseForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Expense Name *</label>
                                <input type="text" class="form-control" name="expense_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Category *</label>
                                <select class="form-control" name="category" required>
                                    <option value="utilities">Utilities</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="supplies">Supplies</option>
                                    <option value="salaries">Salaries</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Amount (₦) *</label>
                                <input type="text" class="form-control" name="amount" id="expense_amount" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" class="form-control" name="expense_date" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #6b6b6b; border-color: #6b6b6b;">
                        <i class="fas fa-save"></i> Save Expense
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="assets/js/jquery-3.5.1.min.js"></script>
<script src="assets/js/popper.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="assets/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="assets/plugins/datatables/datatables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="assets/js/script.js"></script>

<script>
    // Format currency input
    document.getElementById('expense_amount').addEventListener('input', function(e) {
        let value = e.target.value.replace(/,/g, '');
        if (!isNaN(value) && value !== '') {
            e.target.value = parseFloat(value).toLocaleString('en-NG');
        }
    });

    // Handle CSV download
    document.getElementById('download-csv').addEventListener('click', function(e) {
        e.preventDefault();

        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;

        let requestUrl = '/portal/expenses-csv';
        const params = [];

        if (startDate) params.push(`start=${startDate}`);
        if (endDate) params.push(`end=${endDate}`);

        if (params.length > 0) {
            requestUrl += '?' + params.join('&');
        }

        const link = document.createElement('a');
        link.href = requestUrl;
        link.click();
    });

    // Add expense form submission
    document.getElementById('addExpenseForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = {};
        formData.forEach((value, key) => {
            if (key === 'amount') {
                data[key] = value.replace(/,/g, '');
            } else {
                data[key] = value;
            }
        });

        try {
            const response = await fetch('/portal/expenses/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.status) {
                Toastify({
                    text: result.message,
                    duration: 3000,
                    backgroundColor: "#28a745",
                }).showToast();

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                Toastify({
                    text: result.message || 'Error creating expense',
                    duration: 3000,
                    backgroundColor: "#dc3545",
                }).showToast();
            }
        } catch (error) {
            console.error('Error:', error);
            Toastify({
                text: 'Error creating expense',
                duration: 3000,
                backgroundColor: "#dc3545",
            }).showToast();
        }
    });

    // Delete expense
    async function deleteExpense(id) {
        if (!confirm('Are you sure you want to delete this expense?')) {
            return;
        }

        try {
            const response = await fetch(`/portal/expenses/delete/${id}`, {
                method: 'DELETE',
            });

            const result = await response.json();

            if (result.status) {
                Toastify({
                    text: result.message,
                    duration: 3000,
                    backgroundColor: "#28a745",
                }).showToast();

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                Toastify({
                    text: result.message || 'Error deleting expense',
                    duration: 3000,
                    backgroundColor: "#dc3545",
                }).showToast();
            }
        } catch (error) {
            console.error('Error:', error);
            Toastify({
                text: 'Error deleting expense',
                duration: 3000,
                backgroundColor: "#dc3545",
            }).showToast();
        }
    }

    // Edit expense (placeholder - can be enhanced)
    function editExpense(id) {
        alert('Edit functionality coming soon!');
    }
</script>

