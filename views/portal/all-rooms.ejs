<%- include('partial/header', { title: 'Wishmewell Apartment',email:email,roleName:roleName }) %>
<%- include('partial/sidebar', { name: name}) %>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<style>
	.retention-badge {
		background: #808080;
		color: white;
		padding: 4px 10px;
		border-radius: 6px;
		font-size: 12px;
		font-weight: 500;
	}
	.retention-info {
		font-size: 11px;
		color: #6c757d;
		margin-top: 3px;
	}
</style>
		<div class="page-wrapper">
			<div class="content container-fluid">
				<div class="page-header">
					<div class="row align-items-center">
						<div class="col">
							<div class="mt-5">
								<% if (roleName !== 'hotel receptionist') { %>
								<h4 class="card-title float-left mt-2">All Rooms</h4> <a href="/portal/add-room" class="btn btn-primary float-right veiwbutton">Add Room</a> </div>
								<% } else { %>
									<h4 class="card-title float-left mt-2">All Rooms</h4>
                                <!-- <h4 class="card-title float-left mt-2">My Rooms</h4> <a href="/portal/my-rooms" class="btn btn-primary float-right veiwbutton">View All</a> </div> -->
                                <% } %>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-sm-12">
						<div class="card card-table">
							<div class="card-body booking_card">
								<div class="table-responsive">
									<table class="datatable table table-stripped table table-hover table-center mb-0">
										<thead>
											<tr>
												<th>Room ID</th>
												<th>Name</th>
												<th>Room Category</th>
												<th>No Beds</th>
												<th>No Guests</th>
												<th>Time</th>
												<th>Status</th>
												<th>Retention</th>
												<% if (roleName === 'ceo' || roleName === "hotelmanager") { %>
												<th class="text-right">Actions</th>
												<% } %>
											</tr>
										</thead>
										<tbody>
											<% data.forEach(result => { %>
											
											<tr>
												<td><%=result.id%></td>
												<td>
													<h2 class="table-avatar">
                                                    <a class="avatar avatar-sm mr-2"><img class="avatar-img rounded-circle" src=<%= result.picture[0]%> alt="Room  Image"></a>
                                                    <a><%=result.room_name%> <span><%=result.room_number%></span></a>
                                                    </h2>
                                                </td>
												<td><%= result.category_name %></td>
												<td><%=result.num_beds%></td>
												<td><%=result.number_of_guests %></td>
												<td><%= new Date(result.createdAt).toISOString().slice(0, 10).replace(/-/g, '/') %></td>
												<td>
													<div class="actions">
														<a href="#" class="btn btn-sm bg-success-light mr-2">
															<%= result.status.toString() === 'true' || result.status.toString() === 'true' ? "inactive" : "active" %>
														</a>
													</div>
												</td>
												<td>
													<% if (result.is_retained) { %>
														<span class="retention-badge">
															<i class="fas fa-lock"></i> RETAINED
														</span>
														<div class="retention-info">
															By: <%= result.retained_by %><br>
															Until: <%= new Date(result.retained_to).toLocaleDateString('en-GB') %>
														</div>
													<% } else { %>
														<button class="btn btn-sm btn-secondary" onclick="openRetainModal(<%=result.id%>, '<%=result.room_name%>', '<%=result.room_number%>')">
															<i class="fas fa-lock"></i> Retain
														</button>
													<% } %>
												</td>
												<td class="text-right">
													<% if (roleName === 'ceo' || roleName === "hotelmanager") { %>
													<div class="dropdown dropdown-action">
														<a href="#" class="action-icon dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
															<i class="fas fa-ellipsis-v ellipse_color"></i>
														</a>
														<div class="dropdown-menu dropdown-menu-right">
															<a class="dropdown-item" href="#" onclick="openImageModal(<%=result.id%>, '<%=result.room_name%>', '<%=result.room_number%>')">
																<i class="fas fa-images m-r-5"></i> Manage Images
															</a>
															<a class="dropdown-item" href="edit-room.html">
																<i class="fas fa-pencil-alt m-r-5"></i> Edit
															</a>
															<% if (result.is_retained) { %>
																<a class="dropdown-item" href="#" onclick="releaseRoom(<%=result.id%>, '<%=result.room_name%>')">
																	<i class="fas fa-unlock m-r-5"></i> Release Retention
																</a>
															<% } %>
															<a class="dropdown-item" href="/portal/category/delete?id=<%=result.id%>" data-toggle="modal" data-target="#delete_asset">
																<i class="fas fa-trash-alt m-r-5"></i> Delete
															</a>
														</div>
													</div>
													<% } %>
												</td>
											</tr>
												
											<% }) %>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="delete_asset" class="modal fade delete-modal" role="dialog">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-body text-center"> <img src="assets/img/sent.png" alt="" width="50" height="46">
							<h3 class="delete_class">Are you sure want to delete this Asset?</h3>
							<div class="m-t-20"> <a href="#" class="btn btn-white" data-dismiss="modal">Close</a>
								<button type="submit" class="btn btn-danger">Delete</button>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Image Management Modal -->
			<div id="imageManagementModal" class="modal fade" role="dialog">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header" style="background: linear-gradient(135deg, #1c2830 0%, #2a3a45 100%); color: white;">
							<h5 class="modal-title" id="imageModalTitle"><i class="fas fa-images"></i> Manage Room Images</h5>
							<button type="button" class="close text-white" data-dismiss="modal">
								<span>&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<input type="hidden" id="imageModalRoomId">

							<!-- Upload Section -->
							<div class="card mb-3">
								<div class="card-header bg-light">
									<h6 class="mb-0"><i class="fas fa-upload"></i> Upload New Images</h6>
								</div>
								<div class="card-body">
									<div class="form-group">
										<input type="file" class="form-control" id="roomImageInput" accept="image/*" multiple>
										<small class="form-text text-muted">You can select multiple images at once</small>
									</div>
									<button type="button" class="btn btn-primary" onclick="uploadRoomImages()">
										<i class="fas fa-cloud-upload-alt"></i> Upload Images
									</button>
								</div>
							</div>

							<!-- Gallery Section -->
							<div class="card">
								<div class="card-header bg-light">
									<h6 class="mb-0"><i class="fas fa-images"></i> Current Images</h6>
								</div>
								<div class="card-body">
									<div class="row" id="imageGallery">
										<p class="text-center">Loading images...</p>
									</div>
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Retain Room Modal -->
			<div id="retainRoomModal" class="modal fade" role="dialog">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header" style="background: linear-gradient(135deg, #1c2830 0%, #2a3a45 100%); color: white;">
							<h5 class="modal-title"><i class="fas fa-lock"></i> Retain Room</h5>
							<button type="button" class="close text-white" data-dismiss="modal">
								<span>&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<form id="retainRoomForm">
								<input type="hidden" id="retain_room_id">
								<div class="form-group">
									<label><i class="fas fa-door-open"></i> Room</label>
									<input type="text" class="form-control" id="retain_room_display" readonly>
								</div>
								<div class="form-group">
									<label><i class="fas fa-calendar-check"></i> From Date</label>
									<input type="date" class="form-control" id="retained_from" required>
								</div>
								<div class="form-group">
									<label><i class="fas fa-calendar-times"></i> To Date</label>
									<input type="date" class="form-control" id="retained_to" required>
								</div>
								<div class="form-group">
									<label><i class="fas fa-comment"></i> Reason (Optional)</label>
									<textarea class="form-control" id="retention_reason" rows="3" placeholder="Enter reason for retention"></textarea>
								</div>
								<div class="text-right">
									<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
									<button type="submit" class="btn btn-primary" style="background: #1c2830; border: none;">
										<i class="fas fa-lock"></i> Retain Room
									</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

<script>
function openRetainModal(roomId, roomName, roomNumber) {
	document.getElementById('retain_room_id').value = roomId;
	document.getElementById('retain_room_display').value = roomName + ' (' + roomNumber + ')';

	const today = new Date().toISOString().split('T')[0];
	document.getElementById('retained_from').setAttribute('min', today);
	document.getElementById('retained_to').setAttribute('min', today);

	$('#retainRoomModal').modal('show');
}

document.getElementById('retainRoomForm').addEventListener('submit', async function(e) {
	e.preventDefault();

	const roomId = document.getElementById('retain_room_id').value;
	const retainedFrom = document.getElementById('retained_from').value;
	const retainedTo = document.getElementById('retained_to').value;
	const retentionReason = document.getElementById('retention_reason').value;

	if (new Date(retainedTo) <= new Date(retainedFrom)) {
		Toastify({
			text: "End date must be after start date",
			duration: 3000,
			gravity: "top",
			position: "right",
			style: { background: "#dc3545" }
		}).showToast();
		return;
	}

	try {
		const response = await fetch('/portal/room/retain', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				room_id: roomId,
				retained_from: retainedFrom,
				retained_to: retainedTo,
				retention_reason: retentionReason
			})
		});

		const result = await response.json();

		if (result.status) {
			Toastify({
				text: "Room retained successfully!",
				duration: 3000,
				gravity: "top",
				position: "right",
				style: { background: "#28a745" }
			}).showToast();

			$('#retainRoomModal').modal('hide');
			setTimeout(() => window.location.reload(), 1500);
		} else {
			throw new Error(result.message);
		}
	} catch (error) {
		Toastify({
			text: "Error: " + error.message,
			duration: 3000,
			gravity: "top",
			position: "right",
			style: { background: "#dc3545" }
		}).showToast();
	}
});

async function releaseRoom(roomId, roomName) {
	if (!confirm(`Are you sure you want to release retention for ${roomName}?`)) {
		return;
	}

	try {
		const response = await fetch('/portal/room/release', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				room_id: roomId
			})
		});

		const result = await response.json();

		if (result.status) {
			Toastify({
				text: "Room retention released successfully!",
				duration: 3000,
				gravity: "top",
				position: "right",
				style: { background: "#28a745" }
			}).showToast();

			setTimeout(() => window.location.reload(), 1500);
		} else {
			throw new Error(result.message);
		}
	} catch (error) {
		Toastify({
			text: "Error: " + error.message,
			duration: 3000,
			gravity: "top",
			position: "right",
			style: { background: "#dc3545" }
		}).showToast();
	}
}

function openImageModal(roomId, roomName, roomNumber) {
	document.getElementById('imageModalRoomId').value = roomId;
	document.getElementById('imageModalTitle').innerText = `Manage Images - ${roomName} (${roomNumber})`;
	document.getElementById('imageGallery').innerHTML = '<p class="text-center">Loading images...</p>';

	// Load existing images
	loadRoomImages(roomId);

	$('#imageManagementModal').modal('show');
}

async function loadRoomImages(roomId) {
	try {
		const response = await fetch(`/images?for=hotelroom&room_id=${roomId}`);
		const result = await response.json();

		const gallery = document.getElementById('imageGallery');

		if (result.status && result.data.images.length > 0) {
			gallery.innerHTML = result.data.images.map(img => `
				<div class="col-md-3 mb-3">
					<div class="card">
						<img src="${img.url}" class="card-img-top" alt="Room Image" style="height: 150px; object-fit: cover;">
						<div class="card-body p-2 text-center">
							<button class="btn btn-sm btn-danger" onclick="deleteRoomImage('${img.url}', ${roomId})">
								<i class="fas fa-trash"></i> Delete
							</button>
						</div>
					</div>
				</div>
			`).join('');
		} else {
			gallery.innerHTML = '<p class="text-center text-muted">No images uploaded yet</p>';
		}
	} catch (error) {
		console.error('Error loading images:', error);
		document.getElementById('imageGallery').innerHTML = '<p class="text-center text-danger">Error loading images</p>';
	}
}

async function uploadRoomImages() {
	const roomId = document.getElementById('imageModalRoomId').value;
	const fileInput = document.getElementById('roomImageInput');
	const files = fileInput.files;

	if (files.length === 0) {
		Toastify({
			text: "Please select at least one image",
			duration: 3000,
			gravity: "top",
			position: "right",
			style: { background: "#dc3545" }
		}).showToast();
		return;
	}

	const formData = new FormData();
	for (let i = 0; i < files.length; i++) {
		formData.append('image', files[i]);
	}

	try {
		const response = await fetch(`/images?for=hotelroom&room_id=${roomId}`, {
			method: 'POST',
			body: formData
		});

		const result = await response.json();

		if (result.status) {
			Toastify({
				text: "Images uploaded successfully!",
				duration: 3000,
				gravity: "top",
				position: "right",
				style: { background: "#28a745" }
			}).showToast();

			// Clear file input
			fileInput.value = '';

			// Reload images
			loadRoomImages(roomId);
		} else {
			throw new Error(result.message || 'Upload failed');
		}
	} catch (error) {
		Toastify({
			text: "Error: " + error.message,
			duration: 3000,
			gravity: "top",
			position: "right",
			style: { background: "#dc3545" }
		}).showToast();
	}
}

async function deleteRoomImage(imageUrl, roomId) {
	if (!confirm('Are you sure you want to delete this image?')) {
		return;
	}

	try {
		const response = await fetch('/images', {
			method: 'DELETE',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({ url: imageUrl })
		});

		const result = await response.json();

		if (result.status) {
			Toastify({
				text: "Image deleted successfully!",
				duration: 3000,
				gravity: "top",
				position: "right",
				style: { background: "#28a745" }
			}).showToast();

			// Reload images
			loadRoomImages(roomId);
		} else {
			throw new Error(result.message || 'Delete failed');
		}
	} catch (error) {
		Toastify({
			text: "Error: " + error.message,
			duration: 3000,
			gravity: "top",
			position: "right",
			style: { background: "#dc3545" }
		}).showToast();
	}
}
</script>

	<script data-cfasync="false" src="../../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
	<script src="assets/js/jquery-3.5.1.min.js"></script>
	<script src="assets/js/popper.min.js"></script>
	<script src="assets/js/bootstrap.min.js"></script>
	<script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
	<script src="assets/plugins/raphael/raphael.min.js"></script>
	<script src="assets/plugins/datatables/jquery.dataTables.min.js"></script>
	<script src="assets/plugins/datatables/datatables.min.js"></script>
	<script src="assets/js/script.js"></script>
	<script src="https://cdn.metroui.org.ua/current/metro.js"></script>
</body>

</html>