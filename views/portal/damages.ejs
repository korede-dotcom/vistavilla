<%- include('partial/header', { title: 'Damages & Repairs - Wishmewell Apartment',email:email,roleName:roleName }) %>
<%- include('partial/sidebar', { name: name}) %>

<div class="page-wrapper">
    <div class="content container-fluid">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col">
                    <div class="mt-5">
                        <h4 class="card-title float-left mt-2">
                            <i class="fas fa-tools" style="color: #FFA500;"></i> Damages & Repairs
                        </h4>
                        <button class="btn btn-primary float-right veiwbutton" data-toggle="modal" data-target="#addDamageModal">
                            <i class="fas fa-plus"></i> Report Damage
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card board1 fill">
                    <div class="card-body">
                        <div class="dash-widget-header">
                            <div>
                                <h3 class="card_widget_header"><%= damages.length %></h3>
                                <h6 class="text-muted">Total Reports</h6>
                            </div>
                            <div class="ml-auto mt-md-3 mt-lg-0">
                                <span class="opacity-7 text-muted">
                                    <i class="fas fa-list fa-2x" style="color: #FFA500;"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card board1 fill">
                    <div class="card-body">
                        <div class="dash-widget-header">
                            <div>
                                <h3 class="card_widget_header" style="color: #dc3545;">
                                    ₦<%= damages.reduce((sum, d) => sum + (d.amount / 100), 0).toLocaleString() %>
                                </h3>
                                <h6 class="text-muted">Total Cost</h6>
                            </div>
                            <div class="ml-auto mt-md-3 mt-lg-0">
                                <span class="opacity-7 text-muted">
                                    <i class="fas fa-money-bill-wave fa-2x" style="color: #dc3545;"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card board1 fill">
                    <div class="card-body">
                        <div class="dash-widget-header">
                            <div>
                                <h3 class="card_widget_header" style="color: #FFA500;">
                                    <%= damages.filter(d => d.status === 'pending').length %>
                                </h3>
                                <h6 class="text-muted">Pending</h6>
                            </div>
                            <div class="ml-auto mt-md-3 mt-lg-0">
                                <span class="opacity-7 text-muted">
                                    <i class="fas fa-clock fa-2x" style="color: #FFA500;"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card board1 fill">
                    <div class="card-body">
                        <div class="dash-widget-header">
                            <div>
                                <h3 class="card_widget_header" style="color: #28a745;">
                                    <%= damages.filter(d => d.status === 'completed').length %>
                                </h3>
                                <h6 class="text-muted">Completed</h6>
                            </div>
                            <div class="ml-auto mt-md-3 mt-lg-0">
                                <span class="opacity-7 text-muted">
                                    <i class="fas fa-check-circle fa-2x" style="color: #28a745;"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <div class="card card-table">
                    <div class="card-body booking_card">
                        <!-- Date Filter and Download Section -->
                        <div class="mb-4">
                            <form method="get" action="/portal/damages" id="filterForm">
                                <div class="row align-items-end">
                                    <div class="col-md-3">
                                        <label for="start_date" class="font-weight-bold">
                                            <i class="fas fa-calendar-alt"></i> Start Date
                                        </label>
                                        <input type="date" id="start_date" name="start" class="form-control">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="end_date" class="font-weight-bold">
                                            <i class="fas fa-calendar-alt"></i> End Date
                                        </label>
                                        <input type="date" id="end_date" name="end" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-primary mr-2">
                                            <i class="fas fa-filter"></i> Filter
                                        </button>
                                        <button type="button" id="download-csv" class="btn btn-success mr-2">
                                            <i class="fas fa-download"></i> Download CSV
                                        </button>
                                        <a href="/portal/damages" class="btn btn-secondary">
                                            <i class="fas fa-redo"></i> Reset
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="table-responsive">
                            <table class="datatable table table-stripped table table-hover table-center mb-0">
                                <thead>
                                    <tr>
                                        <th>S/N</th>
                                        <th>Room</th>
                                        <th>Description</th>
                                        <th>Action Type</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Recorded By</th>
                                        <th class="text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (damages && damages.length > 0) { %>
                                        <% damages.forEach((damage, index) => { %>
                                            <tr>
                                                <td><%= index + 1 %></td>
                                                <td>
                                                    <strong><%= damage.room_number %></strong><br>
                                                    <small class="text-muted"><%= damage.room_name || 'N/A' %></small>
                                                </td>
                                                <td><%= damage.damage_description %></td>
                                                <td>
                                                    <% if (damage.action_type === 'repair') { %>
                                                        <span class="badge badge-warning">
                                                            <i class="fas fa-wrench"></i> Repair
                                                        </span>
                                                    <% } else { %>
                                                        <span class="badge badge-danger">
                                                            <i class="fas fa-exchange-alt"></i> Replace
                                                        </span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <strong style="color: #dc3545;">
                                                        ₦<%= (damage.amount / 100).toLocaleString('en-NG', {minimumFractionDigits: 2}) %>
                                                    </strong>
                                                </td>
                                                <td><%= new Date(damage.damage_date).toLocaleDateString('en-GB') %></td>
                                                <td>
                                                    <% if (damage.status === 'pending') { %>
                                                        <span class="badge badge-warning">Pending</span>
                                                    <% } else if (damage.status === 'in_progress') { %>
                                                        <span class="badge badge-info">In Progress</span>
                                                    <% } else { %>
                                                        <span class="badge badge-success">Completed</span>
                                                    <% } %>
                                                </td>
                                                <td><%= damage.recorded_by || 'N/A' %></td>
                                                <td class="text-right">
                                                    <% if (damage.status !== 'completed') { %>
                                                        <button class="btn btn-sm btn-success" onclick="updateStatus(<%= damage._id %>, 'completed')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    <% } %>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteDamage(<%= damage._id %>)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="9" class="text-center">No damage reports found</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Damage Modal -->
<div class="modal fade" id="addDamageModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background: #FFA500; color: white;">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Report Damage
                </h5>
                <button type="button" class="close" data-dismiss="modal" style="color: white;">
                    <span>&times;</span>
                </button>
            </div>
            <form id="addDamageForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Room *</label>
                                <select class="form-control" name="room_number" id="room_select" required>
                                    <option value="">Select Room</option>
                                    <%
                                    // Group rooms by category
                                    const roomsByCategory = {};
                                    rooms.forEach(room => {
                                        const categoryName = room.roomcategory ? room.roomcategory.category_name : 'Uncategorized';
                                        if (!roomsByCategory[categoryName]) {
                                            roomsByCategory[categoryName] = [];
                                        }
                                        roomsByCategory[categoryName].push(room);
                                    });

                                    // Display rooms grouped by category
                                    Object.keys(roomsByCategory).sort().forEach(categoryName => {
                                    %>
                                        <optgroup label="<%= categoryName %>">
                                            <% roomsByCategory[categoryName].forEach(room => { %>
                                                <option value="<%= room.room_number %>" data-name="<%= room.room_name %>">
                                                    <%= room.room_number %> - <%= room.room_name %>
                                                </option>
                                            <% }) %>
                                        </optgroup>
                                    <% }) %>
                                </select>
                                <input type="hidden" name="room_name" id="room_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Action Type *</label>
                                <select class="form-control" name="action_type" required>
                                    <option value="repair">Repair</option>
                                    <option value="replace">Replace</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Amount (₦) *</label>
                                <input type="text" class="form-control" name="amount" id="damage_amount" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" class="form-control" name="damage_date" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Damage Description *</label>
                        <textarea class="form-control" name="damage_description" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #FFA500; border-color: #FFA500;">
                        <i class="fas fa-save"></i> Save Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="assets/js/jquery-3.5.1.min.js"></script>
<script src="assets/js/popper.min.js"></script>
<script src="assets/js/bootstrap.min.js"></script>
<script src="assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="assets/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="assets/plugins/datatables/datatables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="assets/js/script.js"></script>

<script>
    // Update room name when room is selected
    document.getElementById('room_select').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const roomName = selectedOption.getAttribute('data-name');
        document.getElementById('room_name').value = roomName || '';
    });

    // Format currency input
    document.getElementById('damage_amount').addEventListener('input', function(e) {
        let value = e.target.value.replace(/,/g, '');
        if (!isNaN(value) && value !== '') {
            e.target.value = parseFloat(value).toLocaleString('en-NG');
        }
    });

    // Handle CSV download
    document.getElementById('download-csv').addEventListener('click', function(e) {
        e.preventDefault();

        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;

        let requestUrl = '/portal/damages-csv';
        const params = [];

        if (startDate) params.push(`start=${startDate}`);
        if (endDate) params.push(`end=${endDate}`);

        if (params.length > 0) {
            requestUrl += '?' + params.join('&');
        }

        const link = document.createElement('a');
        link.href = requestUrl;
        link.click();
    });

    // Add damage form submission
    document.getElementById('addDamageForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = {};
        formData.forEach((value, key) => {
            if (key === 'amount') {
                data[key] = value.replace(/,/g, '');
            } else {
                data[key] = value;
            }
        });

        try {
            const response = await fetch('/portal/damages/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.status) {
                Toastify({
                    text: result.message,
                    duration: 3000,
                    backgroundColor: "#28a745",
                }).showToast();

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                Toastify({
                    text: result.message || 'Error creating damage report',
                    duration: 3000,
                    backgroundColor: "#dc3545",
                }).showToast();
            }
        } catch (error) {
            console.error('Error:', error);
            Toastify({
                text: 'Error creating damage report',
                duration: 3000,
                backgroundColor: "#dc3545",
            }).showToast();
        }
    });

    // Update damage status
    async function updateStatus(id, status) {
        if (!confirm('Mark this damage as completed?')) {
            return;
        }

        try {
            const response = await fetch(`/portal/damages/status/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status })
            });

            const result = await response.json();

            if (result.status) {
                Toastify({
                    text: result.message,
                    duration: 3000,
                    backgroundColor: "#28a745",
                }).showToast();

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                Toastify({
                    text: result.message || 'Error updating status',
                    duration: 3000,
                    backgroundColor: "#dc3545",
                }).showToast();
            }
        } catch (error) {
            console.error('Error:', error);
            Toastify({
                text: 'Error updating status',
                duration: 3000,
                backgroundColor: "#dc3545",
            }).showToast();
        }
    }

    // Delete damage
    async function deleteDamage(id) {
        if (!confirm('Are you sure you want to delete this damage report?')) {
            return;
        }

        try {
            const response = await fetch(`/portal/damages/delete/${id}`, {
                method: 'DELETE',
            });

            const result = await response.json();

            if (result.status) {
                Toastify({
                    text: result.message,
                    duration: 3000,
                    backgroundColor: "#28a745",
                }).showToast();

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                Toastify({
                    text: result.message || 'Error deleting damage report',
                    duration: 3000,
                    backgroundColor: "#dc3545",
                }).showToast();
            }
        } catch (error) {
            console.error('Error:', error);
            Toastify({
                text: 'Error deleting damage report',
                duration: 3000,
                backgroundColor: "#dc3545",
            }).showToast();
        }
    }
</script>

